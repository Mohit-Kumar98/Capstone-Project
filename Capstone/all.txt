from PyPDF2 import PdfReader
from langchain import PromptTemplate
from langchain.chat_models import ChatOpenAI
from langchain.chains.summarize import load_summarize_chain
from langchain.text_splitter import RecursiveCharacterTextSplitter

# Read text from PDF file
pdfreader = PdfReader('financial_report.pdf')  # Update with your actual PDF file path
text = ''
for page in pdfreader.pages:
    content = page.extract_text()
    if content:
        text += content

# Initialize the OpenAI LLM
llm = ChatOpenAI(temperature=0, model_name='gpt-3.5-turbo')

# Split the text into chunks
text_splitter = RecursiveCharacterTextSplitter(chunk_size=10000, chunk_overlap=20)
chunks = text_splitter.create_documents([text])

# Define the custom prompt for summarizing financial reports
SUMMARIZER_PROMPT_TEMPLATE = """
You are an AI tasked with summarizing a company's financial reports, including multiple financial analyst reports and the company's filings. The goal is to create concise 1-page and 2-page summaries that provide a comprehensive overview of the company's financial position. Analyze the provided financial reports and extract relevant data to generate a summary that includes the following sections:

1. Business Overview:
   - Formation/Incorporation Date
   - Headquarters Location
   - Business Description
   - Employee Count
   - Latest Revenues
   - Stock Exchange Listing and Market Capitalization
   - Number of Offices and Locations
   - Details on Clients/Customers

2. Segment Overview:
   - Description of Major Segments
   - Revenue and Growth by Segment
   - Key Products/Services in Each Segment

3. Performance:
   - Year-over-Year Performance
   - Quarterly Performance
   - Key Performance Indicators (KPIs)
   - Comparison with Industry Benchmarks

4. Geographical Data:
   - Revenue by Region
   - Major Markets
   - Regional Performance

5. SWOT Analysis:
   - Strengths
   - Weaknesses
   - Opportunities
   - Threats

6. Credit Rating:
   - Latest Credit Rating
   - Credit Rating Agency
   - Factors Influencing the Credit Rating

7. Key Financial Ratios:
   - Profitability Ratios
   - Liquidity Ratios
   - Leverage Ratios
   - Efficiency Ratios

8. Future Outlook:
   - Management's Forward-Looking Statements
   - Expected Growth and Expansion Plans
   - Potential Risks and Challenges

Summarize the financial report by including the above sections. Ensure the summary is concise, clear, and covers all the necessary details to give a comprehensive understanding of the company's financial health and strategic direction.
"""
map_prompt_template = PromptTemplate(input_variables=['text'], template=SUMMARIZER_PROMPT_TEMPLATE)

# Define the final combine prompt (if needed)
final_combine_prompt = """
Provide a final summary of the financial reports with these important points.
Speech: `{text}`
"""
final_combine_prompt_template = PromptTemplate(input_variables=['text'], template=final_combine_prompt)

# Create the summarize chain with custom prompts
summary_chain = load_summarize_chain(
    llm=llm,
    chain_type='map_reduce',
    map_prompt=map_prompt_template,
    combine_prompt=final_combine_prompt_template,
    verbose=False
)

# Run the summary chain
output = summary_chain.run(chunks)
print(output)
